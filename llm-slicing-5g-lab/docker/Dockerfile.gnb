# SPDX-FileCopyrightText: Copyright (c) 2023-2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Dockerfile for OpenAirInterface gNodeB with E2 support
# Builds from slicing-spring-of-code branch with FlexRIC integration
#
# FIX APPLIED: Uses mouse07410/asn1c pinned to pre-Jan-2025 commit
# This provides BOTH -gen-APER support AND correct hyphen-to-underscore conversion
#
#---------------------------------------------------------------------
# BUILDER IMAGE
#---------------------------------------------------------------------
ARG BASE_IMAGE=ubuntu:22.04

FROM $BASE_IMAGE AS gnb-base
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Paris

# Install build dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get upgrade --yes && \
    DEBIAN_FRONTEND=noninteractive apt-get install --yes \
       build-essential \
       cmake \
       ninja-build \
       git \
       wget \
       libsctp-dev \
       libconfig++-dev \
       libatlas-base-dev \
       liblapacke-dev \
       libboost-all-dev \
       python3 \
       python3-pip \
       gcc-12 \
       g++-12 \
       libusb-1.0-0-dev \
       libuhd-dev \
       uhd-host \
       net-tools \
       iproute2 \
       iputils-ping \
       iperf3 \
       libyaml-cpp-dev \
       libgtest-dev \
       googletest && \
    apt-get clean

# Set gcc-12 as default
RUN update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100 && \
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100

#---------------------------------------------------------------------
# BUILD CUSTOM ASN1C COMPILER
# Using mouse07410/asn1c pinned to pre-Jan-2025 (before hyphen bug)
# This is the ONLY fork with -gen-APER support required by OAI
#---------------------------------------------------------------------
FROM gnb-base AS asn1c-builder

WORKDIR /workspace

# Install asn1c build dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install --yes \
       autoconf \
       automake \
       libtool \
       bison \
       flex && \
    apt-get clean

# Clone mouse07410/asn1c and checkout a known-good commit from before Jan 2025
# The hyphen-to-underscore bug (CVE-2025-55398) was introduced around March 2025
RUN git clone https://github.com/mouse07410/asn1c.git && \
    cd asn1c && \
    git checkout vlm_master && \
    # Find the latest commit before 2025-01-01 (well before the bug)
    GOOD_COMMIT=$(git rev-list -n 1 --before="2025-01-01" vlm_master) && \
    echo "Using asn1c commit: $GOOD_COMMIT" && \
    git checkout $GOOD_COMMIT && \
    git log -n1 --oneline && \
    autoreconf -iv && \
    ./configure --prefix=/opt/asn1c && \
    make -j$(nproc) && \
    make install

# Verify -gen-APER support exists
RUN /opt/asn1c/bin/asn1c -h 2>&1 | head -5 && \
    echo "Testing -gen-APER support..." && \
    /opt/asn1c/bin/asn1c -gen-APER 2>&1 | grep -q "No input files" && \
    echo "SUCCESS: asn1c supports -gen-APER"

#---------------------------------------------------------------------
# BUILD OPENAIRINTERFACE
#---------------------------------------------------------------------
FROM gnb-base AS gnb-builder

# Copy custom asn1c to /opt/asn1c (where OAI expects it)
COPY --from=asn1c-builder /opt/asn1c /opt/asn1c

# Also copy to a backup location (build_oai -I will try to overwrite /opt/asn1c)
COPY --from=asn1c-builder /opt/asn1c /opt/asn1c_good

WORKDIR /workspace

# Clone OpenAirInterface 5G from specific branch
RUN git clone https://gitlab.eurecom.fr/oai/openairinterface5g.git && \
    cd openairinterface5g && \
    git checkout slicing-spring-of-code

WORKDIR /workspace/openairinterface5g

# Install dependencies (this may overwrite /opt/asn1c with buggy version)
RUN cd cmake_targets && \
    ./build_oai -I || true

# Restore our good asn1c (overwrite whatever build_oai -I installed)
RUN rm -rf /opt/asn1c && \
    cp -r /opt/asn1c_good /opt/asn1c && \
    echo "Restored good asn1c:" && \
    /opt/asn1c/bin/asn1c -h 2>&1 | head -3

# Build gNodeB and nrUE with E2 support and RF simulator
# Explicitly specify our asn1c path
RUN cd cmake_targets && \
    ./build_oai -c -C -w SIMU --gNB --nrUE --build-e2 --ninja \
        --cmake-opt -DASN1C_EXEC=/opt/asn1c/bin/asn1c && \
    echo "--- Build completed ---" && \
    ls -lh ran_build/build/nr-softmodem && \
    echo "--- Checking nr-softmodem dependencies ---" && \
    ldd ran_build/build/nr-softmodem | head -30

#---------------------------------------------------------------------
# TARGET IMAGE
#---------------------------------------------------------------------
FROM $BASE_IMAGE AS oai-gnb

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Paris

# Install runtime dependencies only
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get upgrade --yes && \
    DEBIAN_FRONTEND=noninteractive apt-get install --yes \
       libsctp1 \
       libconfig9 \
       libconfig++9v5 \
       libatlas3-base \
       liblapacke \
       libboost-chrono1.74.0 \
       libboost-date-time1.74.0 \
       libboost-filesystem1.74.0 \
       libboost-program-options1.74.0 \
       libboost-regex1.74.0 \
       libboost-serialization1.74.0 \
       libboost-system1.74.0 \
       libboost-thread1.74.0 \
       libusb-1.0-0 \
       libuhd4.1.0 \
       net-tools \
       iproute2 \
       iputils-ping \
       iperf3 \
       procps \
       python3 \
       python3-six \
       python3-requests \
       coreutils && \
    apt-get autoremove -y && \
    apt-get autoclean -y

WORKDIR /opt/oai-gnb

# Copy gNodeB binary
COPY --from=gnb-builder \
    /workspace/openairinterface5g/cmake_targets/ran_build/build/nr-softmodem \
    /opt/oai-gnb/bin/nr-softmodem

# Copy required shared libraries (use wildcards for flexibility)
COPY --from=gnb-builder \
    /workspace/openairinterface5g/cmake_targets/ran_build/build/*.so \
    /usr/local/lib/

# Update library cache and verify dependencies
RUN ldconfig && \
    echo "--- Verifying nr-softmodem dependencies ---" && \
    ldd /opt/oai-gnb/bin/nr-softmodem

# Create necessary directories
RUN mkdir -p /opt/oai-gnb/etc && \
    mkdir -p /opt/oai-gnb/logs && \
    mkdir -p /usr/local/lib/flexric

# Copy FlexRIC Service Module libraries
COPY docker/flexric-sm/*.so /usr/local/lib/flexric/

# Expose ports
# NGAP (N2 interface to AMF)
EXPOSE 38412/sctp
# GTP-U (N3 interface to UPF)
EXPOSE 2152/udp
# E2 interface to RIC
EXPOSE 36421/sctp

# Set LD_LIBRARY_PATH
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

WORKDIR /opt/oai-gnb

# Default command (will be overridden by docker-compose)
CMD ["/opt/oai-gnb/bin/nr-softmodem"]